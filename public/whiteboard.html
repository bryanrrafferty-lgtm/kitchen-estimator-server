<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Whiteboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
    .pdf-link-btn {
        font-size: 0.95rem !important;
    }
    .totals-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; color: #007bff; }
    .totals-list { list-style: none; padding: 0; margin: 0; width: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f4f7fa; color: #333; }
        .layout-flex { display: flex; flex-direction: row; min-height: 100vh; }
        .active-projects-label { font-weight: 500; color: #555; margin-top: 1.5rem; margin-bottom: 0.25rem; font-size: 1.05rem; }
        .active-projects-value { font-weight: bold; color: #28a745; font-size: 1.2rem; margin-bottom: 1.5rem; }
        .main-content { flex: 1 1 0%; padding: 0; }
        .center-header { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 2rem; }
        .logo-circle { height: 65px; width: 65px; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 50%; border: 1px solid #ccc; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .logo-circle img { height: 65px; width: 65px; border-radius: 50%; object-fit: cover; display: block; }
        .digital-whiteboard-title { font-size: 2rem; font-weight: bold; margin-bottom: 0; text-align: center; }
        .status-select {
            min-width: 140px;
            width: 100%;
            font-weight: 500;
        }
        .status-up-to-date {
            background-color: #c8e6c9 !important;
            color: #256029 !important;
        }
        .status-complete {
            background-color: #bbdefb !important;
            color: #0d47a1 !important;
        }
        .status-need-data {
            background-color: #fff9c4 !important;
            color: #7c6f00 !important;
        }
        .status-hold {
            background-color: #ffcdd2 !important;
            color: #b71c1c !important;
        }
        .po-col,
        th.po-col {
            width: 70px;
            min-width: 60px;
            max-width: 90px;
            text-align: center;
            vertical-align: middle !important;
            padding-top: 18px !important;
            padding-bottom: 0 !important;
            line-height: 1.2 !important;
        }
        .not-received-col,
        th.not-received-col {
            width: 110px;
            min-width: 90px;
            max-width: 120px;
            text-align: center;
        }
        .card.shadow-sm.p-3 {
            width: calc(100% + 48px);
            max-width: none;
            background: #fff;
            box-sizing: border-box;
            overflow-x: auto;
        }
        .table-responsive#projectList {
            width: 100%;
            max-width: none;
        }
        .po-checkbox-cell {
            background-color: #ffebee; /* light red by default */
            transition: background-color 0.2s;
            text-align: center;
            vertical-align: bottom !important;
        }
        .po-checkbox-cell.checked {
            background-color: #c8e6c9 !important; /* green when checked */
        }
        .po-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #28a745;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 sidebar">
                <!-- Logo and title removed from sidebar -->
                <div class="sidebar-section">
                    <h5>Totals</h5>
                    <ul class="totals-list mb-section">
                        <li><span class="totals-label">Total</span> <span class="totals-value" id="total-total">0.00</span></li>
                        <li><span class="totals-label">Received</span> <span class="totals-value" id="total-received">0.00</span></li>
                        <li><span class="totals-label">Balance</span> <span class="totals-value" id="total-balance">0.00</span></li>
                        <li><span class="totals-label">Daily</span> <span class="totals-value" id="total-daily">0.00</span></li>
                    </ul>
                </div>
                <div class="sidebar-section">
                    <span class="active-projects-label">Active Projects</span>
                    <span class="active-projects-value" id="active-projects-count">0</span>
                </div>
                <div class="sidebar-section">
                    <div id="receiving-reports-dropzone" class="dropzone-blue mb-2">
                        Drag &amp; Drop Receiving Report
                    </div>
                    <ul id="receiving-reports-list" class="list-unstyled mb-0">
                        <li class="list-loading">Loading...</li>
                    </ul>
                </div>
                <div class="sidebar-section">
                    <div id="po-dropzone" class="dropzone-blue mb-2">
                        Drag &amp; Drop Purchase Order
                    </div>
                    <ul id="po-list" class="list-unstyled mb-0">
                        <li class="list-loading">Loading...</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-9">
                <div class="center-header">
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <div class="logo-circle mb-0">
                            <img src="CKS Logo.png" alt="CKS Logo" onerror="this.style.display='none'">
                        </div>
                        <h1 class="digital-whiteboard-title mb-0">Digital Whiteboard</h1>
                    </div>
                </div>
                <div class="card shadow-sm p-3">
                    <!-- Invoice Buttons (moved to left above table) -->
                    <div class="d-flex justify-content-start mb-3">
                        <button class="btn btn-success me-2" id="openInvoiceModalBtn">Monthly Storage</button>
                        <button class="btn btn-primary" id="openOutboundInvoiceBtn">Outbound Invoice</button>
                    </div>
                    <div class="table-responsive" id="projectList">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">Customer</th>
                                    <th scope="col">Project</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Received</th>
                                    <th scope="col">Balance</th>
                                    <th scope="col" class="po-col po-col-center">PO</th>
                                    <th scope="col" class="status-col">Status</th>
                                    <th scope="col" class="not-received-col">Not Received</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Invoice Modal -->
                    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="invoiceModalLabel">Generate Invoice</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="invoiceProjectSelect" class="form-label">Project</label>
                                        <select class="form-select" id="invoiceProjectSelect"></select>
                                    </div>
                                    <div id="monthlyFields">
                                        <div class="mb-3">
                                            <label for="invoiceStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="invoiceStartDate">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoiceEndDate" class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="invoiceEndDate">
                                        </div>
                                    </div>
                                    <div id="outboundFields" style="display:none;">
                                        <div class="mb-3">
                                            <label for="deliveryPrice" class="form-label">Delivery Price</label>
                                            <input type="number" class="form-control" id="deliveryPrice" min="0" step="0.01" value="400.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="generateInvoiceBtn">Generate</button>
                                    <button type="button" class="btn btn-primary" id="generateOutboundInvoiceBtn" style="display:none;">Generate</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Invoice Modal Logic
        document.addEventListener('DOMContentLoaded', function() {
            let invoiceProjects = [];
            const invoiceModalEl = document.getElementById('invoiceModal');
            const invoiceBtn = document.getElementById('openInvoiceModalBtn');
            // Button definitions
            const outboundBtn = document.getElementById('openOutboundInvoiceBtn');
            // Monthly Storage button logic
            invoiceBtn.addEventListener('click', async function() {
                // Show modal, show monthly fields, hide outbound fields
                const monthlyFields = document.getElementById('monthlyFields');
                const outboundFields = document.getElementById('outboundFields');
                const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
                const generateOutboundInvoiceBtn = document.getElementById('generateOutboundInvoiceBtn');
                if (monthlyFields) monthlyFields.style.display = '';
                if (outboundFields) outboundFields.style.display = 'none';
                if (generateInvoiceBtn) generateInvoiceBtn.style.display = '';
                if (generateOutboundInvoiceBtn) generateOutboundInvoiceBtn.style.display = 'none';
                // Fetch active projects for dropdown
                const res = await fetch('/api/project-summaries');
                invoiceProjects = await res.json();
                const invoiceProjectSelect = document.getElementById('invoiceProjectSelect');
                invoiceProjectSelect.innerHTML = '';
                invoiceProjects.forEach(p => {
                    const key = p.project_key || p.projectId || p.projectKey;
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${p.customer || ''} - ${p.projectName || key}`;
                    invoiceProjectSelect.appendChild(opt);
                });
                const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                modal.show();
            });
            // Outbound Invoice button logic
            outboundBtn.addEventListener('click', async function() {
                // Show modal, hide monthly fields, show outbound fields
                const monthlyFields = document.getElementById('monthlyFields');
                const outboundFields = document.getElementById('outboundFields');
                const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
                const generateOutboundInvoiceBtn = document.getElementById('generateOutboundInvoiceBtn');
                if (monthlyFields) monthlyFields.style.display = 'none';
                if (outboundFields) outboundFields.style.display = '';
                if (generateInvoiceBtn) generateInvoiceBtn.style.display = 'none';
                if (generateOutboundInvoiceBtn) generateOutboundInvoiceBtn.style.display = '';
                // Fetch active projects for dropdown
                const res = await fetch('/api/project-summaries');
                const projects = await res.json();
                const invoiceProjectSelect = document.getElementById('invoiceProjectSelect');
                invoiceProjectSelect.innerHTML = '';
                projects.forEach(p => {
                    const key = p.project_key || p.projectId || p.projectKey;
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${p.customer || ''} - ${p.projectName || key}`;
                    invoiceProjectSelect.appendChild(opt);
                });
                const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                modal.show();
            });
            // Outbound Invoice modal generate button
            document.getElementById('generateOutboundInvoiceBtn').addEventListener('click', async function() {
                const projectKey = document.getElementById('invoiceProjectSelect').value;
                const deliveryPrice = Number(document.getElementById('deliveryPrice').value) || 0;
                if (!projectKey) {
                    alert('Please select a project.');
                    return;
                }
                // Get all inventory items
                const res = await fetch('/api/inventory/all');
                const items = res.ok ? await res.json() : [];
                // Filter for Shipping tab items for selected project
                const shippingItems = items.filter(i => (i.type === 'Shipping') && (i.project_key === projectKey || i.projectKey === projectKey || i.projectId === projectKey));
                if (!shippingItems.length) {
                    alert('No Shipping items found for this project.');
                    return;
                }
                // Get project info
                let projectInfo = {};
                const projectRes = await fetch(`/api/projects/${encodeURIComponent(projectKey)}`);
                if (projectRes.ok) projectInfo = await projectRes.json();
                generateOutboundInvoicePDF(projectInfo, shippingItems, deliveryPrice);
                bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
            });
        // Outbound Invoice PDF generation
    async function generateOutboundInvoicePDF(project, items, deliveryPrice) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 12;
            // Logo
            let logoDataUrl = '';
            try {
                logoDataUrl = await getImageBase64('CKS Logo.png');
            } catch { logoDataUrl = ''; }
            if (logoDataUrl) doc.addImage(logoDataUrl, 'PNG', 14, y, 22, 22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0,0,0);
            doc.setFontSize(13);
            doc.text('Commercial Kitchen Solutions', 38, y + 7);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Outbound Invoice', 38, y + 14);
            doc.text(`Project: ${project.customer || ''} - ${project.projectName || project.project_key || ''}`, 14, y + 30);
            doc.text(`Date: ${(new Date()).toISOString().slice(0,10)}`, 14, y + 36);
            // Table
            const tableBody = items.map(item => [
                item.itemNumber || '',
                item.supplierId || '',
                item.itemType || '',
                item.modelNumber || '',
                item.quantity || '',
                item.weight || '',
                item.movedDate ? item.movedDate.slice(0, 10) : ''
            ]);
            doc.autoTable({
                head: [['Item #', 'Supplier', 'Item', 'Model', 'Qty', 'Weight', 'Date Shipped']],
                body: tableBody,
                startY: y + 40,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: {
                    fillColor: [135, 113, 78], // PMS 872 gold
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 10
                }
            });
            // Total weight and billing
            const totalWeight = items.reduce((sum, i) => sum + Number(i.weight || 0), 0);
            const billing = (totalWeight * 0.05).toFixed(2);
            doc.text(`Total Weight: ${totalWeight.toFixed(2)} lbs`, 14, doc.lastAutoTable.finalY + 10);
            doc.text(`Outbound Billing (@ $0.05/lb): $${billing}`, 14, doc.lastAutoTable.finalY + 16);
            doc.text(`Delivery Price: $${deliveryPrice.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 22);
            doc.text(`Total Due: $${(Number(billing) + deliveryPrice).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 28);
            doc.save(`Outbound_Invoice_${project.projectName || project.project_key || 'All'}_${(new Date()).toISOString().slice(0,10)}.pdf`);
        }
            document.getElementById('generateInvoiceBtn').addEventListener('click', async function() {
                console.log('[Monthly Storage] Generate button clicked');
                try {
                const projectKey = invoiceProjectSelect.value;
                const startDate = document.getElementById('invoiceStartDate').value;
                const endDate = document.getElementById('invoiceEndDate').value;
                console.log('[Monthly Storage] Selected:', { projectKey, startDate, endDate });
                if (!projectKey || !startDate || !endDate) {
                    alert('Please select a project and both dates.');
                    return;
                }
                // Fetch items for project from dailyTotals
                const res = await fetch(`/api/daily-totals?projectKey=${encodeURIComponent(projectKey)}&startDate=${startDate}&endDate=${endDate}`);
                const items = await res.json();
                console.log('[Monthly Storage] Invoice PDF items:', items);
                if (!items.length) {
                    alert('No items found for the selected project and date range.');
                    return;
                }
                // Generate PDF (packing list style)
                // Find project by any key
                const projectObj = invoiceProjects.find(p => p.project_key === projectKey || p.projectId === projectKey || p.projectKey === projectKey);
                console.log('[Monthly Storage] Project object:', projectObj);
                generateInvoicePDF(projectObj, items, startDate, endDate);
                bootstrap.Modal.getInstance(invoiceModalEl).hide();
                } catch (err) {
                    alert('Error generating invoice: ' + err.message);
                }
            });
        });

        async function generateInvoicePDF(project, items, startDate, endDate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 12;
            // Logo
            let logoDataUrl = '';
            try {
                logoDataUrl = await getImageBase64('CKS Logo.png');
            } catch { logoDataUrl = ''; }
            if (logoDataUrl) doc.addImage(logoDataUrl, 'PNG', 14, y, 22, 22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0,0,0);
            doc.setFontSize(13);
            doc.text('Commercial Kitchen Solutions', 38, y + 7);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Invoice for Storage', 38, y + 14);
            doc.text(`Project: ${project.customer || ''} - ${project.projectName || project.project_key}`, 14, y + 30);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, y + 36);
            // Table
            const tableBody = items.map(item => [
                item.itemNumber || '',
                item.supplierId || '',
                item.itemType || '',
                item.modelNumber || '',
                item.quantity || '',
                item.squareft || '',
                item.weight || '',
                item.movedDate ? item.movedDate.slice(0, 10) : ''
            ]);
            doc.autoTable({
                head: [['Item #', 'Supplier', 'Item', 'Model', 'Qty', 'Sq Ft', 'Weight', 'Date Moved']],
                body: tableBody,
                startY: y + 40,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: {
                    fillColor: [135, 113, 78], // PMS 872 gold
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 10
                }
            });
            // Total sq ft and billing
            const totalSqFt = items.reduce((sum, i) => sum + Number(i.squareft || 0), 0);
            const billing = (totalSqFt * 3).toFixed(2);
            doc.text(`Total Sq Ft: ${totalSqFt.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.text(`Monthly Billing (@ $3.00/sq ft): $${billing}`, 14, doc.lastAutoTable.finalY + 16);
            doc.save(`Invoice_${project.projectName || project.project_key}_${startDate}_to_${endDate}.pdf`);
        }
        function getStatusClass(status) {
            switch ((status || '').toUpperCase()) {
                case 'UP TO DATE': return 'status-up-to-date';
                case 'COMPLETE': return 'status-complete';
                case 'NEED DATA': return 'status-need-data';
                case 'HOLD': return 'status-hold';
                default: return '';
            }
        }

        function buildStatusSelect(currentStatus) {
            const statuses = ["UP TO DATE", "COMPLETE", "NEED DATA", "HOLD"];
            let html = `<select class="form-select form-select-sm status-select ${getStatusClass(currentStatus)}" aria-label="Status">`;
            for (const status of statuses) {
                html += `<option value="${status}"${status === currentStatus ? ' selected' : ''}>${status}</option>`;
            }
            html += `</select>`;
            return html;
        }

        async function loadProjects() {
                // Fetch all inventory items and group by project for received calculation
                let dailyReceived = 0;
                let inventoryItems = [];
                try {
                    let inventoryRes = await fetch('/api/inventory/all');
                    inventoryItems = inventoryRes.ok ? await inventoryRes.json() : [];
                    console.log('Fetched inventory items:', inventoryItems);
                    let today = new Date().toISOString().slice(0, 10);
                    inventoryItems.forEach(item => {
                        if ((item.type === 'Receiving' || item.type === 'Inventory') && item.movedDate && item.movedDate.slice(0, 10) === today) {
                            dailyReceived += Number(item.squareft) || 0;
                        }
                    });
                } catch (err) {
                    dailyReceived = 0;
                }
            try {
                const response = await fetch('/api/project-summaries');
                if (!response.ok) throw new Error('Failed to fetch project summaries');
                const projects = await response.json();
                // Sort by customer name, then project name
                projects.sort((a, b) => {
                    const customerA = (a.customer || '').toLowerCase();
                    const customerB = (b.customer || '').toLowerCase();
                    if (customerA !== customerB) return customerA.localeCompare(customerB);
                    const projectA = (a.projectName || a.project_key || '').toLowerCase();
                    const projectB = (b.projectName || b.project_key || '').toLowerCase();
                    return projectA.localeCompare(projectB);
                });
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                let totalTotal = 0, totalReceived = 0, totalBalance = 0;
                let today = new Date().toISOString().slice(0, 10);
                let storedDay = localStorage.getItem('dailySqFtDay');
                let dailySqFt = storedDay === today ? Number(localStorage.getItem('dailySqFt')) || 0 : 0;

                // Calculate totals using inventoryItems for each project
                let totalSqFt = 0, receivedSqFt = 0, balanceSqFt = 0;
                let activeProjects = 0;
                projects.forEach(project => {
                    const projectKey = project.project_key || project.projectKey || project.projectId;
                    // All items for this project
                    const itemsForProject = inventoryItems.filter(item =>
                        item.project_key === projectKey ||
                        item.projectKey === projectKey ||
                        item.projectId === projectKey
                    );
                    // Total = sum of squareft for all items
                    const total = itemsForProject.reduce((sum, i) => sum + Number(i.squareft || 0), 0);
                    // Received = sum of squareft for Inventory and Shipping items
                    const received = itemsForProject.filter(i => i.type === 'Inventory' || i.type === 'Shipping')
                        .reduce((sum, i) => sum + Number(i.squareft || 0), 0);
                    // Balance = total - received
                    const balance = total - received;
                    totalSqFt += total;
                    receivedSqFt += received;
                    balanceSqFt += balance;
                    const row = document.createElement('tr');
                    row.dataset.projectKey = projectKey;
                    row.innerHTML =
                        `<td><strong>${project.customer || ''}</strong></td>
                        <td>${project.projectName || projectKey || ''}</td>
                        <td>${total.toFixed(2)}</td>
                        <td>${received.toFixed(2)}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td class="po-checkbox-cell"><input type="checkbox" class="po-checkbox" onchange="togglePOCheckbox(this, '${projectKey}')" ${project.poChecked ? 'checked' : ''}></td>
                        <td>${buildStatusSelect(project.status || '')}</td>
                        <td class="center-cell"><button class="btn btn-sm btn-primary pdf-link-btn" onclick="generateReceivingPDF('${projectKey}')">PDF</button></td>`;
                    tbody.appendChild(row);
                    // Set the correct color class after rendering
                    const select = row.querySelector('.status-select');
                    const statusClass = getStatusClass(project.status || '');
                    if (statusClass) select.classList.add(statusClass);
                    activeProjects += 1;
                });

                document.getElementById('total-total').textContent = totalSqFt.toFixed(2);
                document.getElementById('total-received').textContent = receivedSqFt.toFixed(2);
                document.getElementById('total-balance').textContent = balanceSqFt.toFixed(2);
                document.getElementById('active-projects-count').textContent = activeProjects;
                document.getElementById('total-daily').textContent = dailyReceived.toFixed(2);

                if (projects.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" class="text-center">No projects found</td>';
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '<tr><td colspan="7" class="error">Error loading projects: ' + error.message + '</td></tr>';
                document.getElementById('total-total').textContent = '0.00';
                document.getElementById('total-received').textContent = '0.00';
                document.getElementById('total-balance').textContent = '0.00';
                document.getElementById('active-projects-count').textContent = '0';
            }
        }

        // Handle status change and persist it
        document.addEventListener('change', async function(e) {
            if (e.target.classList.contains('status-select')) {
                const select = e.target;
                const row = select.closest('tr');
                const projectKey = row.dataset.projectKey;
                const newStatus = select.value;
                // Remove all status color classes, then add the new one
                select.classList.remove('status-up-to-date', 'status-complete', 'status-need-data', 'status-hold');
                const newClass = getStatusClass(newStatus);
                if (newClass) select.classList.add(newClass);
                // Persist the status change
                try {
                    await fetch('/api/project/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            project_key: projectKey,
                            updates: { status: newStatus }
                        })
                    });
                } catch (err) {
                    alert('Failed to update status: ' + err.message);
                }
            }
        });

        // PDF generation for Receiving tab items only, with CKS logo, address, and correct fonts
        async function generateReceivingPDF(projectKey) {
            try {
                // Fetch items in Receiving for this project
                const response = await fetch(`/api/inventory/Receiving?project_key=${encodeURIComponent(projectKey)}`);
                if (!response.ok) throw new Error('Failed to fetch Receiving items');
                let items = await response.json();

                // Filter items by projectKey in case the backend does not filter
                items = items.filter(item =>
                    item.project_key === projectKey ||
                    item.projectKey === projectKey ||
                    item.projectId === projectKey
                );

                if (!items.length) {
                    alert('No Receiving items found for this project.');
                    return;
                }

                // Fetch project info for address block
                const projectInfoRes = await fetch(`/api/projects/${encodeURIComponent(projectKey)}`);
                let projectInfo = {};
                if (projectInfoRes.ok) {
                    projectInfo = await projectInfoRes.json();
                }

                // Packing List columns: Item #, Supplier, Item, Model, Quantity, Weight
                const tableBody = items.map(item => [
                    item.itemNumber || '',
                    item.supplierId || item.supplier || '',
                    item.itemType || '',
                    item.modelNumber || '',
                    item.quantity || '',
                    item.weight || ''
                ]);

                // Load logo as base64
                let logoDataUrl = '';
                try {
                    logoDataUrl = await getImageBase64('CKS Logo.png');
                } catch {
                    logoDataUrl = '';
                }

                // Use jsPDF from window.jspdf
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 12;

                // Draw logo
                if (logoDataUrl) {
                    doc.addImage(logoDataUrl, 'PNG', 14, y, 22, 22);
                }

                // Set font to Arial for all non-table text
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.text('Commercial Kitchen Solutions', 38, y + 7);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('1234 Main Street', 38, y + 14);
                doc.text('Phoenix, AZ 85001', 38, y + 19);
                doc.text('480-555-1234', 38, y + 24);

                // Title: Customer / Project / Missing Items Report
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                let titleY = y + 32;
                let customer = projectInfo.customer || '';
                let project = projectInfo.projectName || projectKey || '';
                doc.text(`${customer} / ${project} / Missing Items Report`, 14, titleY);

                // Table: Use Arial Narrow (simulated with 'helvetica' and fontSize 9 for narrow effect)
                doc.autoTable({
                    head: [['Item #', 'Supplier', 'Item', 'Model', 'Quantity', 'Weight']],
                    body: tableBody,
                    startY: titleY + 6,
                    styles: {
                        font: 'helvetica', // Arial Narrow is not available, helvetica is closest
                        fontStyle: 'normal',
                        fontSize: 9,
                        textColor: [0, 0, 0],
                        lineColor: [0, 0, 0],
                        lineWidth: 0.2,
                        cellPadding: 3,
                        halign: 'left',
                        valign: 'middle',
                    },
                    headStyles: {
                        font: 'helvetica',
                        fontStyle: 'bold',
                        fontSize: 10,
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        lineColor: [0, 0, 0],
                        lineWidth: 0.5,
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245],
                        textColor: [0, 0, 0]
                    },
                    tableLineColor: [0, 0, 0],
                    tableLineWidth: 0.5,
                    columnStyles: {
                        3: { cellWidth: 24 } // Make Model column (now index 3) smaller
                    }
                });
                doc.save(`Receiving_Missing_Items_${projectKey}.pdf`);
            } catch (err) {
                alert('Failed to generate PDF: ' + err.message);
            }
        }

        window.generateReceivingPDF = generateReceivingPDF;

        window.onload = async () => {
            await loadProjects();
            setInterval(loadProjects, 15000);
        };

        async function loadReceivingReports() {
            try {
                const res = await fetch('/api/rreport/list');
                if (!res.ok) throw new Error('Failed to load reports');
                const files = await res.json();
                const list = document.getElementById('receiving-reports-list');
                list.innerHTML = '';
                if (!files.length) {
                    list.innerHTML = '<li class="list-item-default">No reports found</li>';
                    return;
                }
                files.forEach(filename => {
                    const li = document.createElement('li');
                    li.classList.add('list-item-margin');
                    // PDF link (no icon)
                    const link = document.createElement('a');
                    link.href = `/rreport/${encodeURIComponent(filename)}`;
                    link.textContent = filename;
                    link.target = '_blank';
                    link.className = 'pdf-link';
                    li.appendChild(link);

                    // Trash icon
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                    deleteBtn.title = 'Delete';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.background = 'none';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.marginLeft = '0.5em';
                    deleteBtn.onclick = async (e) => {
                        e.preventDefault();
                        if (confirm(`Delete ${filename}?`)) {
                            await fetch(`/api/rreport/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                            loadReceivingReports();
                        }
                    };
                    li.appendChild(deleteBtn);

                    list.appendChild(li);
                });
            } catch (err) {
                const list = document.getElementById('receiving-reports-list');
                list.innerHTML = `<li class="list-item-error">Error loading reports</li>`;
            }
        }

        async function loadPurchaseOrders() {
            try {
                const res = await fetch('/api/po/list');
                if (!res.ok) throw new Error('Failed to load purchase orders');
                const files = await res.json();
                const list = document.getElementById('po-list');
                list.innerHTML = '';
                if (!files.length) {
                    list.innerHTML = '<li class="list-item-default">No purchase orders found</li>';
                    return;
                }
                files.forEach(filename => {
                    const li = document.createElement('li');
                    li.classList.add('list-item-margin');
                    // PDF link (no icon)
                    const link = document.createElement('a');
                    link.href = `/po/${encodeURIComponent(filename)}`;
                    link.textContent = filename;
                    link.target = '_blank';
                    link.style.textDecoration = 'none';
                    link.style.color = '#0d6efd'; // Standard hyperlink blue
                    link.style.fontSize = '1.05rem'; // Increased by 1pt
                    link.onmouseover = () => link.style.textDecoration = 'underline';
                    link.onmouseout = () => link.style.textDecoration = 'none';
                    li.appendChild(link);

                    // Trash icon
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                    deleteBtn.title = 'Delete';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.background = 'none';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.marginLeft = '0.5em';
                    deleteBtn.onclick = async (e) => {
                        e.preventDefault();
                        if (confirm(`Delete ${filename}?`)) {
                            await fetch(`/api/po/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                            loadPurchaseOrders();
                        }
                    };
                    li.appendChild(deleteBtn);

                    list.appendChild(li);
                });
            } catch (err) {
                const list = document.getElementById('po-list');
                list.innerHTML = `<li class="list-item-error">Error loading purchase orders</li>`;
            }
        }

        // Call both functions on load and every 15 seconds
        document.addEventListener('DOMContentLoaded', () => {
            loadReceivingReports();
            loadPurchaseOrders();
            setInterval(loadReceivingReports, 15000);
            setInterval(loadPurchaseOrders, 15000);

            setupDropZone(
                'receiving-reports-dropzone',
                '/api/rreport/upload',
                loadReceivingReports
            );
            setupDropZone(
                'po-dropzone',
                '/api/po/upload',
                loadPurchaseOrders
            );
        });

        // Add this script after your other scripts

        function setupDropZone(dropzoneId, uploadUrl, refreshFn) {
            const dropzone = document.getElementById(dropzoneId);

            dropzone.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropzone.style.background = '#e3f0ff';
                dropzone.style.borderColor = '#0056b3';
            });

            dropzone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                dropzone.style.background = '#f8fbff';
                dropzone.style.borderColor = '#0d6efd';
            });

            dropzone.addEventListener('drop', async function (e) {
                e.preventDefault();
                dropzone.style.background = '#f8fbff';
                dropzone.style.borderColor = '#0d6efd';

                const files = Array.from(e.dataTransfer.files);
                const pdfs = files.filter(file => file.type === 'application/pdf');
                if (pdfs.length === 0) {
                    alert('Please drop PDF files only.');
                    return;
                }

                for (const file of pdfs) {
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const res = await fetch(uploadUrl, {
                            method: 'POST',
                            body: formData
                        });
                        if (!res.ok) throw new Error('Upload failed');
                    } catch (err) {
                        alert('Failed to upload: ' + file.name);
                    }
                }
                refreshFn();
            });
        }

        function togglePOCheckbox(checkbox, projectKey) {
            const cell = checkbox.closest('.po-checkbox-cell');
            if (checkbox.checked) {
                cell.classList.add('checked');
            } else {
                cell.classList.remove('checked');
            }
            // Persist PO checkbox state
            fetch('/api/project/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_key: projectKey,
                    updates: { poChecked: checkbox.checked }
                })
            });
        }

        // Helper to load image as base64
        function getImageBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new window.Image();
                img.crossOrigin = '';
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = function() {
                    reject(new Error('Logo image could not be loaded.'));
                };
                // Use absolute path for logo
                img.src = window.location.origin + '/CKS Logo.png';
            });
        }
    </script>
</body>
</html>